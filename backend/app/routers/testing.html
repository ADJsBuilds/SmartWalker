<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Avatar stream</title>
    <style>
      body { font-family: system-ui; padding: 16px; }
      #media video { width: 520px; border-radius: 12px; display: block; }
      #media audio { display: block; }
      .muted { color: #666; }
      pre { background: #f6f6f6; padding: 12px; border-radius: 10px; overflow: auto; }
    </style>
  </head>
  <body>
    <h2>Avatar stream</h2>
    <div id="status" class="muted">loading…</div>
    <div id="media"></div>
    <pre id="log"></pre>

    <script type="module">
      const logEl = document.getElementById("log");
      const statusEl = document.getElementById("status");
      const log = (...args) => {
        console.log(...args);
        logEl.textContent += args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ") + "\n";
      };
      const status = (s) => { statusEl.textContent = s; log("STATUS:", s); };

      // ✅ CDN ESM import (must be type="module")
      import { Room, RoomEvent } from "https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.esm.mjs";

      const LIVEKIT_URL = "wss://heygen-feapbkvq.livekit.cloud";
      const TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NzExNTgzODMsImlzcyI6IkFQSVByREUyNXZZRldERyIsIm5hbWUiOiJjbGllbnQiLCJuYmYiOjE3NzEwNzE5ODMsInN1YiI6ImNsaWVudCIsInZpZGVvIjp7ImNhblB1Ymxpc2giOnRydWUsImNhblB1Ymxpc2hEYXRhIjp0cnVlLCJjYW5TdWJzY3JpYmUiOnRydWUsInJvb20iOiI1ZmYxM2E0Yi0wOWEwLTExZjEtOWZkNy04YWYwMTU5MTE3ZmYiLCJyb29tSm9pbiI6dHJ1ZX19.OsfDggCuZzzAFz2l5z0nLfpbs9yspB_W4iex1_C1zUM";

      const room = new Room();

      room.on(RoomEvent.Connected, () => status("connected ✅ (waiting for tracks…)"));
      room.on(RoomEvent.Disconnected, () => status("disconnected ❌"));
      room.on(RoomEvent.ConnectionStateChanged, (state) => log("ConnectionState:", state));
      room.on(RoomEvent.ParticipantConnected, (p) => log("ParticipantConnected:", p.identity));
      room.on(RoomEvent.TrackSubscribed, (track, pub, participant) => {
        log("TrackSubscribed:", track.kind, "from", participant.identity);
        const el = track.attach();
        // browser autoplay policies: allow video to autoplay muted
        if (el.tagName === "VIDEO") { el.autoplay = true; el.muted = true; el.playsInline = true; }
        document.getElementById("media").appendChild(el);
        status("track subscribed ✅");
      });

      try {
        status("connecting…");
        await room.connect(LIVEKIT_URL, TOKEN);
        log("Room name:", room.name);
        log("Local identity:", room.localParticipant.identity);
      } catch (e) {
        status("connect error ❌ (check console/log below)");
        log("ERROR:", e?.message ?? String(e));
        log(e);
      }
    </script>
  </body>
</html>